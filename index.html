<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>KBO ä¾¨é‚¦å›½é™…æ•™è‚²å¸‚åœºéƒ¨ | äº‘ç«¯åŒæ­¥ç‰ˆ V10.20</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f8f9fa; color: #202124; }
        .google-card { background: white; border-radius: 16px; border: 1px solid #dadce0; box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15); }
        .status-pill { border-radius: 8px; font-weight: 700; font-size: 11px; padding: 4px 10px; text-transform: uppercase; cursor: pointer; border: none; }
        .signed-yes { background-color: #e6f4ea; color: #137333; }
        .signed-no { background-color: #f1f3f4; color: #5f6368; }
        .visited-yes { background-color: #e8f0fe; color: #1967d2; }
        th { font-weight: 500; color: #5f6368; font-size: 13px; padding: 12px 8px; border-bottom: 1px solid #dadce0; background: #fff; position: sticky; top: 0; z-index: 10; }
        td { padding: 10px 8px; border-bottom: 1px solid #f1f3f4; }
        .val-name { color: #1a73e8; font-weight: 700; font-size: 14px; }
        .val-type { color: #ea4335; font-weight: 800; }
        .val-source { color: #1e40af; font-weight: 900; font-size: 15px; } 
        .val-price { color: #188038; font-weight: 900; font-size: 16px; }
        .google-input { border: 1px solid #dadce0; border-radius: 8px; padding: 8px 12px; transition: all 0.2s; background: white; }
        .google-input:focus { border-color: #1a73e8; box-shadow: 0 0 0 2px rgba(26,115,232,0.2); outline: none; }
        .cell-edit { width: 100%; background: transparent; border: none; padding: 4px; border-radius: 4px; }
        .cell-edit:focus { background: #fff; box-shadow: 0 0 0 2px #1a73e8; outline: none; }
        .month-chip { padding: 6px 16px; border-radius: 20px; font-size: 13px; border: 1px solid #dadce0; background: #fff; color: #3c4043; transition: all 0.2s; cursor: pointer; }
        .month-chip.active { background: #1a73e8; color: #fff; border-color: #1a73e8; box-shadow: 0 1px 3px rgba(26,115,232,0.4); font-weight: 700; }
        .row-index { color: #bdc1c6; font-family: 'Roboto Mono', monospace; font-weight: bold; font-size: 12px; }
        .filter-select { font-size: 11px; border: 1px solid #eee; border-radius: 4px; padding: 2px; width: 100%; color: #1a73e8; font-weight: bold; background: #fdfdfd; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-[1700px] mx-auto">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-blue-700 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-200">
                    <span class="text-white text-xl font-black italic">KBO</span>
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <h1 class="text-2xl font-black text-gray-900 tracking-tight">KBO ä¾¨é‚¦å›½é™…æ•™è‚²å¸‚åœºéƒ¨</h1>
                        <span id="cloudStatus" class="bg-orange-100 text-orange-600 text-[10px] px-2 py-1 rounded">æ­£åœ¨åŒæ­¥ä¸­...</span>
                    </div>
                    <p class="text-sm text-gray-500 font-medium">äº‘ç«¯åŒæ­¥å·²å¼€å¯ - å…¨å‘˜æ•°æ®å…±äº« (2026ç‰ˆ)</p>
                </div>
            </div>
            <button onclick="exportAll()" class="bg-white border border-gray-300 text-gray-700 px-6 py-2.5 rounded-full font-bold hover:bg-gray-50 shadow-sm transition">å¤‡ä»½å…¨é‡æ•°æ®</button>
        </div>

        <div class="google-card p-4 mb-8 sticky top-4 z-50 flex flex-wrap gap-4 items-center bg-white/95 backdrop-blur-sm">
            <div class="flex gap-2 p-1 bg-gray-100 rounded-full" id="monthTabs"></div>
            <div class="flex-grow"></div>
            <input id="filterName" oninput="renderAll()" type="text" placeholder="ğŸ” æœç´¢å§“å..." class="google-input py-2 w-64 text-sm">
        </div>

        <div class="google-card p-6 mb-8">
            <h2 class="text-gray-500 font-bold text-xs uppercase tracking-widest mb-4 flex items-center gap-2">
                <span class="w-2 h-2 bg-blue-600 rounded-full animate-pulse"></span> å½•å…¥æ–°å®¢èµ„åˆ° <span id="entryMonthLabel" class="text-blue-600 font-black">--</span>
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-10 gap-3">
                <input id="date" type="text" placeholder="æ—¥æœŸ(å¦‚:5æ—¥)" class="google-input text-blue-600 font-bold">
                <input id="name" type="text" placeholder="å®¢æˆ·å§“å*" class="google-input font-bold border-l-4 border-l-blue-600">
                <select id="bizType" class="google-input text-red-600 font-bold">
                    <option value="">ä¸šåŠ¡åˆ†ç±»</option>
                    <option value="ç•™å­¦">ç•™å­¦</option><option value="åŸ¹è®­">åŸ¹è®­</option><option value="åŸ¹è®­+ç•™å­¦">åŸ¹è®­+ç•™å­¦</option>
                </select>
                <select id="group" class="google-input text-purple-600 font-bold">
                    <option value="">å’¨è¯¢ç¾¤ä½“</option>
                    <option value="å°‘å„¿å°åˆ">å°‘å„¿å°åˆ</option><option value="é«˜ä¸­/å¤§å­¦ç”Ÿ">é«˜ä¸­/å¤§å­¦ç”Ÿ</option><option value="æˆäººå®¢æˆ·">æˆäººå®¢æˆ·</option>
                </select>
                <select id="source" class="google-input text-blue-800 font-black">
                    <option value="">å®¢èµ„æ¥æº</option>
                    <option value="ç¾å›¢">ç¾å›¢</option><option value="æŠ–éŸ³">æŠ–éŸ³</option><option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option><option value="è€å®¢æˆ·æ¨è">è€å®¢æˆ·æ¨è</option><option value="å†…éƒ¨å‘˜å·¥">å†…éƒ¨å‘˜å·¥</option><option value="é«˜å¾·/ç™¾åº¦åœ°å›¾">é«˜å¾·/ç™¾åº¦åœ°å›¾</option><option value="å¹¿å‘Šä¸Šé—¨-è‡ªåŠ¨å®£ä¼ ">å¹¿å‘Šä¸Šé—¨-è‡ªåŠ¨å®£ä¼ </option><option value="Wilsonè€æ¿">Wilsonè€æ¿</option><option value="å…¬ä¼—å·/æ‰«ä¸€æ‰«/è§†é¢‘å·">å…¬ä¼—å·/æ‰«ä¸€æ‰«/è§†é¢‘å·</option><option value="æ¸ é“æ¨è">æ¸ é“æ¨è</option><option value="æ´»åŠ¨æ¨å¹¿">æ´»åŠ¨æ¨å¹¿</option>
                </select>
                <select id="advisor" class="google-input text-teal-600 font-bold">
                    <option value="">é¡¾é—®</option>
                    <option value="Dora">Dora</option><option value="VIP">VIP</option><option value="Avril">Avril</option>
                </select>
                <select id="campus" class="google-input text-orange-500 font-bold">
                    <option value="">æ ¡åŒº</option>
                    <option value="é‡‘å±±æ¹–">é‡‘å±±æ¹–</option><option value="ä½³å…†ä¸š">ä½³å…†ä¸š</option>
                </select>
                <input id="demand" type="text" placeholder="éœ€æ±‚å¤‡æ³¨" class="google-input xl:col-span-2">
                <button onclick="addData()" class="bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg transition">ç¡®è®¤æäº¤</button>
            </div>
        </div>

        <div class="google-card overflow-hidden mb-12">
            <div class="p-4 border-b flex justify-between items-center bg-white">
                <h3 class="font-bold text-gray-700" id="part1Title">Part 1. å®¢èµ„è¿½è¸ª</h3>
                <div class="text-sm font-medium flex gap-6">
                    <span class="text-gray-400">ç»“æœ: <b id="totalCount" class="text-blue-600 text-lg">0</b></span>
                    <span class="text-gray-400">å·²ç­¾çº¦: <b id="signedCount" class="text-green-600 text-lg">0</b></span>
                    <button onclick="resetFilters()" class="text-xs text-blue-500 hover:underline">é‡ç½®</button>
                </div>
            </div>
            <div class="overflow-x-auto max-h-[500px]">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr>
                            <th class="pl-4 w-14 text-center">åºå·</th><th class="w-10 text-center">æ’åº</th>
                            <th class="w-24">æ—¥æœŸ</th><th class="w-28">å§“å</th><th class="w-28 text-red-600">åˆ†ç±»</th>
                            <th class="w-32">ç¾¤ä½“</th><th class="w-36">æ¥æº</th><th class="w-24">é¡¾é—®</th>
                            <th class="w-24">æ ¡åŒº</th><th>éœ€æ±‚å¤‡æ³¨</th><th class="w-20 text-center">åˆ°è®¿</th>
                            <th class="w-20 text-center">ç­¾çº¦</th><th class="pr-6 w-10 text-center">åˆ </th>
                        </tr>
                        <tr class="bg-gray-50/50">
                            <th></th><th></th><th></th><th></th>
                            <th class="p-1"><select id="fBiz" onchange="renderAll()" class="filter-select"><option value="">å…¨éƒ¨åˆ†ç±»</option><option value="ç•™å­¦">ç•™å­¦</option><option value="åŸ¹è®­">åŸ¹è®­</option><option value="åŸ¹è®­+ç•™å­¦">åŸ¹è®­+ç•™å­¦</option></select></th>
                            <th class="p-1"><select id="fGroup" onchange="renderAll()" class="filter-select"><option value="">å…¨éƒ¨ç¾¤ä½“</option><option value="å°‘å„¿å°åˆ">å°‘å„¿å°åˆ</option><option value="é«˜ä¸­/å¤§å­¦ç”Ÿ">é«˜ä¸­/å¤§å­¦ç”Ÿ</option><option value="æˆäººå®¢æˆ·">æˆäººå®¢æˆ·</option></select></th>
                            <th class="p-1"><select id="fSource" onchange="renderAll()" class="filter-select"><option value="">å…¨éƒ¨æ¥æº</option><option value="ç¾å›¢">ç¾å›¢</option><option value="æŠ–éŸ³">æŠ–éŸ³</option><option value="å°çº¢ä¹¦">å°çº¢ä¹¦</option><option value="è€å®¢æˆ·æ¨è">è€å®¢æˆ·æ¨è</option><option value="å†…éƒ¨å‘˜å·¥">å†…éƒ¨å‘˜å·¥</option><option value="é«˜å¾·/ç™¾åº¦åœ°å›¾">é«˜å¾·/ç™¾åº¦åœ°å›¾</option><option value="å¹¿å‘Šä¸Šé—¨-è‡ªåŠ¨å®£ä¼ ">å¹¿å‘Šä¸Šé—¨-è‡ªåŠ¨å®£ä¼ </option><option value="Wilsonè€æ¿">Wilsonè€æ¿</option><option value="å…¬ä¼—å·/æ‰«ä¸€æ‰«/è§†é¢‘å·">å…¬ä¼—å·/æ‰«ä¸€æ‰«/è§†é¢‘å·</option><option value="æ¸ é“æ¨è">æ¸ é“æ¨è</option><option value="æ´»åŠ¨æ¨å¹¿">æ´»åŠ¨æ¨å¹¿</option></select></th>
                            <th class="p-1"><select id="fAdv" onchange="renderAll()" class="filter-select"><option value="">å…¨éƒ¨é¡¾é—®</option><option value="Dora">Dora</option><option value="VIP">VIP</option><option value="Avril">Avril</option></select></th>
                            <th class="p-1"><select id="fCampus" onchange="renderAll()" class="filter-select"><option value="">å…¨éƒ¨æ ¡åŒº</option><option value="é‡‘å±±æ¹–">é‡‘å±±æ¹–</option><option value="ä½³å…†ä¸š">ä½³å…†ä¸š</option></select></th>
                            <th></th><th></th><th></th><th></th>
                        </tr>
                    </thead>
                    <tbody id="dataTable"></tbody>
                </table>
            </div>
        </div>

        <div class="google-card overflow-hidden border-t-4 border-t-green-600 mb-20">
            <div class="p-6 bg-green-50/30 flex justify-between items-center border-b border-green-100">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-green-600 rounded-lg text-white font-black italic">KBO</div>
                    <div><h2 class="text-xl font-bold text-gray-900" id="part2Title">Part 2. ç­¾çº¦ä¸šç»©</h2><p class="text-xs text-green-700 font-bold uppercase tracking-wider">MONTHLY REPORT</p></div>
                </div>
                <div class="text-right">
                    <p class="text-gray-500 text-xs font-bold uppercase tracking-widest mb-1">Total Revenue</p>
                    <div class="text-4xl font-black text-green-700 tracking-tighter">Â¥ <span id="totalIncome">0.00</span></div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="pl-4 w-14 text-center">åºå·</th><th class="w-10 text-center">æ’åº</th>
                            <th class="w-32">ç­¾çº¦æ—¥æœŸ</th><th class="w-32">ç­¾çº¦å§“å</th><th class="w-32">æ¥æº</th>
                            <th class="w-40">é¡¹ç›®</th><th class="w-40">é‡‘é¢</th><th class="w-28 text-teal-600">é¡¾é—®</th>
                            <th class="w-28 text-orange-600">å¯¹æ¥äºº</th><th>å¤‡æ³¨</th><th class="pr-6 w-10 text-center">åˆ </th>
                        </tr>
                    </thead>
                    <tbody id="salesTable"></tbody>
                </table>
            </div>
            <div class="p-4 bg-white border-t border-gray-100">
                <button onclick="addSalesRow()" class="bg-green-600 text-white px-8 py-3 rounded-full font-bold hover:bg-green-700 shadow-lg transition">+ å½•å…¥ä¸€ç¬”æ­£å¼ç­¾çº¦</button>
            </div>
        </div>
    </div>

    <script>
        // --- 0. å®‰å…¨æ§åˆ¶ ---
        (function() {
            const MY_SECRET_KEY = "kboverseas2014"; 
            const sessionKey = 'kbo_authenticated';
            if (sessionStorage.getItem(sessionKey) !== 'true') {
                const userInput = prompt("ã€KBOå†…éƒ¨ç³»ç»Ÿã€‘è¯·è¾“å…¥æˆæƒç ï¼š");
                if (userInput === MY_SECRET_KEY) sessionStorage.setItem(sessionKey, 'true');
                else { location.reload(); throw new Error("Unauthorized"); }
            }
        })();

        // --- 1. Supabase é…ç½® ---
        const SUPABASE_URL = 'https://npnzndzrdmujzhiljfpu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wbnpuZHpyZG11anpoaWxqZnB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNzE1NDUsImV4cCI6MjA4NzY0NzU0NX0.DlufgflTX6Y3kK6Is3-v9ZilNvPGvc0AvjmGQyk_rU8';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let db = [];
        let salesDb = [];
        let currentMonthFilter = (new Date().getMonth() + 1) + 'æœˆ';

        const BIZ_TYPES = ["ç•™å­¦", "åŸ¹è®­", "åŸ¹è®­+ç•™å­¦"];
        const GROUPS = ["å°‘å„¿å°åˆ", "é«˜ä¸­/å¤§å­¦ç”Ÿ", "æˆäººå®¢æˆ·"];
        const SOURCES = ["ç¾å›¢", "æŠ–éŸ³", "å°çº¢ä¹¦", "è€å®¢æˆ·æ¨è", "å†…éƒ¨å‘˜å·¥", "é«˜å¾·/ç™¾åº¦åœ°å›¾", "å¹¿å‘Šä¸Šé—¨-è‡ªåŠ¨å®£ä¼ ", "Wilsonè€æ¿", "å…¬ä¼—å·/æ‰«ä¸€æ‰«/è§†é¢‘å·", "æ¸ é“æ¨è", "æ´»åŠ¨æ¨å¹¿"];
        const ADVISORS = ["Dora", "VIP", "Avril"];
        const CAMPUSES = ["é‡‘å±±æ¹–", "ä½³å…†ä¸š"];

        // åˆå§‹åŒ–æœˆä»½æ ‡ç­¾
        const mList = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
        document.getElementById('monthTabs').innerHTML = mList.map(mStr => 
            `<button onclick="setMonthFilter('${mStr}')" class="month-chip ${mStr === currentMonthFilter ? 'active' : ''}" data-month="${mStr}">${mStr}</button>`
        ).join('');

        // --- 2. æ ¸å¿ƒå‡½æ•° ---
        async function fetchAllData() {
            try {
                const { data: crmData, error: e1 } = await _supabase.from('qb_crm_data').select('*').order('id', { ascending: true });
                const { data: sData, error: e2 } = await _supabase.from('qb_sales_data').select('*').order('id', { ascending: true });

                if (e1 || e2) {
                    const errMsg = (e1?.message || "") + (e2?.message || "");
                    document.getElementById('cloudStatus').innerText = "è¿æ¥å¤±è´¥: " + errMsg;
                    document.getElementById('cloudStatus').className = "bg-red-100 text-red-600 text-[10px] px-2 py-1 rounded";
                    return;
                }

                db = crmData || [];
                salesDb = sData || [];
                renderAll();
                
                const statusEl = document.getElementById('cloudStatus');
                statusEl.innerText = "äº‘ç«¯å·²åŒæ­¥ (" + new Date().toLocaleTimeString() + ")";
                statusEl.className = "bg-green-100 text-green-600 text-[10px] px-2 py-1 rounded";
            } catch (err) {
                document.getElementById('cloudStatus').innerText = "ç½‘ç»œå¼‚å¸¸: " + err.message;
            }
        }

        async function addData() {
            const nameEl = document.getElementById('name');
            if(!nameEl.value) return alert("è¯·è¾“å…¥å§“å");
            let dVal = document.getElementById('date').value;
            let finalDate = dVal.includes('æœˆ') ? dVal : (currentMonthFilter + (dVal || new Date().getDate() + "æ—¥"));

            const newItem = {
                id: Date.now(),
                date: finalDate,
                name: nameEl.value,
                bizType: document.getElementById('bizType').value,
                group_name: document.getElementById('group').value,
                source: document.getElementById('source').value,
                advisor: document.getElementById('advisor').value,
                campus: document.getElementById('campus').value,
                isVisited: 'å¦',
                demand: document.getElementById('demand').value,
                isSigned: 'å¦'
            };

            const { error } = await _supabase.from('qb_crm_data').insert([newItem]);
            if(error) alert("ä¿å­˜å¤±è´¥: " + error.message);
            else { nameEl.value = ''; fetchAllData(); }
        }

        async function addSalesRow() {
            const newItem = { 
                id: Date.now(), 
                sdate: currentMonthFilter + new Date().getDate() + "æ—¥", 
                sname: 'æ–°ç­¾çº¦å®¢æˆ·', 
                ssource: 'å¾…å®š', 
                sproj: 'å¾…å®š', 
                sprice: 0, 
                sadv: 'å¾…å®š', 
                sstaff: 'å¾…å®š', 
                snote: '' 
            };
            const { error } = await _supabase.from('qb_sales_data').insert([newItem]);
            if(error) alert("å½•å…¥å¤±è´¥ï¼š" + error.message);
            else fetchAllData();
        }

        async function upItem(id, k, v) {
            const field = k === 'group' ? 'group_name' : k;
            await _supabase.from('qb_crm_data').update({ [field]: v }).eq('id', id);
        }

        async function upS(id, k, v, refresh = false) {
            await _supabase.from('qb_sales_data').update({ [k.toLowerCase()]: v }).eq('id', id);
            if(refresh) fetchAllData();
        }

        async function toggleField(id, k) {
            const item = db.find(i => i.id === id);
            const newVal = item[k] === 'æ˜¯' ? 'å¦' : 'æ˜¯';
            await _supabase.from('qb_crm_data').update({ [k]: newVal }).eq('id', id);
            fetchAllData();
        }

        async function delItem(id) {
            if(confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) { await _supabase.from('qb_crm_data').delete().eq('id', id); fetchAllData(); }
        }

        async function delS(id) {
            if(confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) { await _supabase.from('qb_sales_data').delete().eq('id', id); fetchAllData(); }
        }

        function setMonthFilter(m) {
            currentMonthFilter = m;
            document.querySelectorAll('.month-chip').forEach(b => b.classList.toggle('active', b.dataset.month === m));
            document.getElementById('entryMonthLabel').innerText = m;
            document.getElementById('part1Title').innerText = `Part 1. ${m} å®¢èµ„è¿½è¸ª`;
            document.getElementById('part2Title').innerText = `Part 2. ${m} ç­¾çº¦ä¸šç»©`;
            renderAll();
        }

        function resetFilters() {
            ['fBiz','fGroup','fSource','fAdv','fCampus','filterName'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = "";
            });
            renderAll();
        }

        // --- æ‹–æ‹½ä¸åºå·é€»è¾‘ ---
        function initSortable(tableId) {
            const el = document.getElementById(tableId);
            if (!el) return;
            if (el._sortable) el._sortable.destroy();
            el._sortable = Sortable.create(el, {
                handle: '.cursor-move',
                animation: 150,
                ghostClass: 'bg-blue-50',
                onEnd: function() {
                    reIndexRows(tableId);
                }
            });
        }

        function reIndexRows(tableId) {
            const rows = document.querySelectorAll(`#${tableId} tr`);
            rows.forEach((row, index) => {
                const indexCell = row.querySelector('.row-index');
                if (indexCell) {
                    indexCell.innerText = index + 1;
                }
            });
        }

        function renderAll() {
            const search = document.getElementById('filterName').value.toLowerCase();
            const f1 = document.getElementById('fBiz').value;
            const f2 = document.getElementById('fGroup').value;
            const f3 = document.getElementById('fSource').value;
            const f4 = document.getElementById('fAdv').value;
            const f5 = document.getElementById('fCampus').value;

            // æ¸²æŸ“ Part 1
            const fCRM = db.filter(i => {
                return (i.date || '').includes(currentMonthFilter) &&
                       (search === '' || (i.name||'').toLowerCase().includes(search)) &&
                       (f1 === '' || i.bizType === f1) &&
                       (f2 === '' || i.group_name === f2) &&
                       (f3 === '' || i.source === f3) &&
                       (f4 === '' || i.advisor === f4) &&
                       (f5 === '' || i.campus === f5);
            });

            document.getElementById('dataTable').innerHTML = fCRM.map((i, idx) => `
                <tr>
                    <td class="pl-4 text-center row-index">${idx + 1}</td>
                    <td class="text-gray-300 font-bold text-center cursor-move">â˜°</td>
                    <td><input onchange="upItem(${i.id},'date',this.value)" class="cell-edit text-blue-600 font-medium" value="${i.date||''}"></td>
                    <td><input onchange="upItem(${i.id},'name',this.value)" class="cell-edit val-name" value="${i.name||''}"></td>
                    <td><select onchange="upItem(${i.id},'bizType',this.value)" class="cell-edit val-type"><option value="">--</option>${BIZ_TYPES.map(t => `<option value="${t}" ${i.bizType===t?'selected':''}>${t}</option>`).join('')}</select></td>
                    <td><select onchange="upItem(${i.id},'group_name',this.value)" class="cell-edit val-group"><option value="">--</option>${GROUPS.map(g => `<option value="${g}" ${i.group_name===g?'selected':''}>${g}</option>`).join('')}</select></td>
                    <td><select onchange="upItem(${i.id},'source',this.value)" class="cell-edit val-source">${SOURCES.map(s => `<option value="${s}" ${i.source===s?'selected':''}>${s}</option>`).join('')}</select></td>
                    <td><select onchange="upItem(${i.id},'advisor',this.value)" class="cell-edit val-advisor">${ADVISORS.map(a => `<option value="${a}" ${i.advisor===a?'selected':''}>${a}</option>`).join('')}</select></td>
                    <td><select onchange="upItem(${i.id},'campus',this.value)" class="cell-edit text-orange-600 font-medium">${CAMPUSES.map(c => `<option value="${c}" ${i.campus===c?'selected':''}>${c}</option>`).join('')}</select></td>
                    <td><input onchange="upItem(${i.id},'demand',this.value)" class="cell-edit text-gray-500 text-xs" value="${i.demand||''}"></td>
                    <td class="text-center"><button onclick="toggleField(${i.id},'isVisited')" class="status-pill ${i.isVisited==='æ˜¯'?'visited-yes':'signed-no'}">${i.isVisited==='æ˜¯'?'å·²è®¿':'æœªè®¿'}</button></td>
                    <td class="text-center"><button onclick="toggleField(${i.id},'isSigned')" class="status-pill ${i.isSigned==='æ˜¯'?'signed-yes':'signed-no'}">${i.isSigned==='æ˜¯'?'å·²ç­¾':'è·Ÿè¿›'}</button></td>
                    <td class="pr-6 text-center"><button onclick="delItem(${i.id})" class="text-gray-300 hover:text-red-500">âœ•</button></td>
                </tr>`).join('');

            // æ¸²æŸ“ Part 2
            const fSales = salesDb.filter(s => (s.sdate || s.sDate || '').includes(currentMonthFilter) && (search === '' || (s.sname || s.sName || '').toLowerCase().includes(search)));
            let sum = 0;
            document.getElementById('salesTable').innerHTML = fSales.map((s, idx) => {
                let p = parseFloat(s.sprice || s.sPrice) || 0; sum += p;
                return `<tr>
                    <td class="pl-4 text-center row-index">${idx + 1}</td>
                    <td class="text-gray-300 font-bold text-center cursor-move">â˜°</td>
                    <td><input onchange="upS(${s.id},'sdate',this.value)" class="cell-edit text-blue-600 font-medium" value="${s.sdate || s.sDate || ''}"></td>
                    <td><input onchange="upS(${s.id},'sname',this.value)" class="cell-edit val-name" value="${s.sname || s.sName || ''}"></td>
                    <td><input onchange="upS(${s.id},'ssource',this.value)" class="cell-edit val-source" value="${s.ssource || s.sSource || ''}"></td>
                    <td><input onchange="upS(${s.id},'sproj',this.value)" class="cell-edit font-bold text-gray-700" value="${s.sproj || s.sProj || ''}"></td>
                    <td><input type="number" onchange="upS(${s.id},'sprice',this.value,true)" class="cell-edit val-price" value="${s.sprice || s.sPrice || 0}"></td>
                    <td><input onchange="upS(${s.id},'sadv',this.value)" class="cell-edit val-advisor" value="${s.sadv || s.sAdv || ''}"></td>
                    <td><input onchange="upS(${s.id},'sstaff',this.value)" class="cell-edit text-orange-600 font-medium" value="${s.sstaff || s.sStaff || ''}"></td>
                    <td><input onchange="upS(${s.id},'snote',this.value)" class="cell-edit text-gray-400 text-xs" value="${s.snote || s.sNote || ''}"></td>
                    <td class="pr-6 text-center"><button onclick="delS(${s.id})" class="text-gray-300 hover:text-red-500">âœ•</button></td></tr>`;
            }).join('');
            
            document.getElementById('totalCount').innerText = fCRM.length;
            document.getElementById('signedCount').innerText = fCRM.filter(i => i.isSigned === 'æ˜¯').length;
            document.getElementById('totalIncome').innerText = sum.toLocaleString('zh-CN', {minimumFractionDigits: 2});

            // æ¯æ¬¡æ¸²æŸ“åå¿…é¡»é‡æ–°ç»‘å®šæ‹–æ‹½ï¼Œå¦åˆ™æ‹–æ‹½ä¼šå¤±æ•ˆ
            initSortable('dataTable');
            initSortable('salesTable');
        }

        function exportAll() {
            let csv = "\uFEFFåºå·,æ—¥æœŸ,å§“å,åˆ†ç±»,ç¾¤ä½“,æ¥æº,é¡¾é—®,æ ¡åŒº,åˆ°è®¿,ç­¾çº¦,éœ€æ±‚\n";
            db.forEach((i, idx) => csv += `${idx+1},${i.date},${i.name},${i.bizType},${i.group_name},${i.source},${i.advisor},${i.campus},${i.isVisited},${i.isSigned},"${i.demand}"\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `KBO_DATA_BACKUP_${new Date().toLocaleDateString()}.csv`; link.click();
        }

        // å¯åŠ¨
        fetchAllData();
        setInterval(fetchAllData, 15000); 
    </script>
</body>
</html>
